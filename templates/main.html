{% extends "layout.html" %}
{% block post_body %}
<script type="text/javascript">

    var wid_bar = 25;
    var merg_bar = 2;
    var max_history = 20;

    var box_hei = 80,
            box_wid = (wid_bar + merg_bar) * max_history + merg_bar;

    var msec = 0.001;
    var scale_bar = msec * {{ scale_bar }};
    var scale_unit = 10;

    const const_timeout = {{ const_timeout }};

    var render = function () {
        d3.json("http://localhost:5000/history", function (jdata) {
            var selec_box = d3.select("div.content").selectAll("div.box");

            selec_box
                    .data(jdata)
                    .enter()
                    .append("div").attr("class", "box")
                    .attr("id", get_hostname)
                    .style("width", box_wid + "px").style("height", box_hei + "px");

            selec_box
                    .data(jdata)
                    .exit()
                    .remove();

            for (var res in jdata) {
                selec_box = d3.select("div.content div.box[id='" + jdata[res]["host"] + "']")
                        .selectAll("div.v-bar");

                selec_box
                        .data(jdata[res]["history"])
                        .enter()
                        .append("div")
                        .attr("class", "v-bar")
                        .style("visibility", "hidden")
                        .append("span");
//                        .text(get_seq);

                selec_box
                        .data(jdata[res]["history"])
                        .exit()
                        .remove();

                selec_box
                        .data(jdata[res]["history"])
                        .attr("class", "v-bar")
                        .style("height", get_hei)
                        .style("left", function (d, i) {
                            return (2 + i * 27) + "px"
                        })
                        .style("background-color", get_color)
                        .style("visibility", "visible")
                        .select("span")
                        .text(get_seq);
            }
        });
    };

    var get_hostname = function (d) {
        return d["host"];
    };

    var get_rtt = function (d) {
        return d["rtt"];
    };

    var get_seq = function (d) {
        return d["seq"];
    };

    var get_hei = function (d) {
        return (get_rtt(d) * 100) + "px";
    };

    var get_color = function(d) {
        if (d["rtt"] == const_timeout) {
            return "#9E446B"
        };
        return "#7783d7";
    };

    setInterval(render, 2000);
    render();

</script>
{% endblock %}