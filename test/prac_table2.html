<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>Raw Selection</title>
    <link rel="stylesheet" type="text/css" href="./pure-min-custum.css"/>
    <script type="text/javascript" src="../static/d3.js"></script>
</head>

<body>
<script type="text/javascript">

    var msec = 0.001;
    var scale_bar = msec * 10;
    var scale_unit = 5;
    const min_height = 15;

    var wid_bar = 25;
    var merg_bar = 2;
    var max_history = 20;

    var box_hei = 150,
            box_wid = (wid_bar + merg_bar) * max_history + merg_bar;

    var get_hostname = function (d) {
        return d["host"];
    };

    var get_seq = function (d) {
        return d["seq"];
    };

    var get_hei = function (d) {if (d["rtt"] == const_timeout) {
            return min_height + "px"
        };
//        return (Math.ceil(get_rtt(d) / scale_bar) * 30) + "px";
        return (Math.ceil(get_rtt(d) / scale_bar) * scale_unit + min_height) + "px";
//        return (get_rtt(d) * 100) + "px";
    };

    var ordered_values = function (dict, key_order) {
        var val_order = [];
        for (var k in key_order) {
            var key = key_order[k];
            var val = dict[key];

            if (key == "avg") {
                val = fmt_nanosec(val);
            } else if (key == "loss") {
                val = fmt_percent(val);
            }
            ;

            val_order.push(val);
        }
        ;
        return val_order;
    };

    var get_rtt = function (d) {
        return d["rtt"];
    };

    var get_color = function(d) {
        if (d["rtt"] == const_timeout) {
            return "#9E446B"
        };
        return "#7783d7";
    };

    const const_timeout = -1;

    var fmt_percent = d3.format(",.1%");
    var fmt_nanosec = d3.format(".6f");

    var jdata = [
        {
            'history': [{'rtt': 0.04822111129760742, 'seq': 1},
                {'rtt': 0.043118953704833984, 'seq': 2},
                {'rtt': 0.02956390380859375, 'seq': 3},
                {'rtt': 0.04815506935119629, 'seq': 4},
                {'rtt': 0.03673291206359863, 'seq': 5},
                {'rtt': 0.03180694580078125, 'seq': 6},
                {'rtt': 0.043650150299072266, 'seq': 7},
                {'rtt': 0.043853044509887695, 'seq': 8},
                {'rtt': 0.07187390327453613, 'seq': 9},
                {'rtt': 0.07205510139465332, 'seq': 10},
                {'rtt': 0.06355690956115723, 'seq': 11},
                {'rtt': 0.029977083206176758, 'seq': 12},
                {'rtt': 0.039576053619384766, 'seq': 13},
                {'rtt': 0.03020191192626953, 'seq': 14},
                {'rtt': 0.1114189624786377, 'seq': 15},
                {'rtt': 0.14194297790527344, 'seq': 16},
                {'rtt': 0.029324054718017578, 'seq': 17},
                {'rtt': 0.0833427906036377, 'seq': 18}],
            'host': '173.194.126.148',
            'stats': {'avg': 0.055465102195739746, 'loss': 0.0, 'recv': 18, 'sent': 18}
        },
        {
            'history': [{'rtt': 0.044409990310668945, 'seq': 1},
                {'rtt': 0.04280900955200195, 'seq': 2},
                {'rtt': 0.02915501594543457, 'seq': 3},
                {'rtt': 0.04769396781921387, 'seq': 4},
                {'rtt': 0.03613400459289551, 'seq': 5},
                {'rtt': 0.031404972076416016, 'seq': 6},
                {'rtt': 0.04316115379333496, 'seq': 7},
                {'rtt': 0.04347991943359375, 'seq': 8},
                {'rtt': 0.07143211364746094, 'seq': 9},
                {'rtt': 0.07164502143859863, 'seq': 10},
                {'rtt': 0.06311798095703125, 'seq': 11},
                {'rtt': 0.030046939849853516, 'seq': 12},
                {'rtt': 0.039189815521240234, 'seq': 13},
                {'rtt': 0.029819965362548828, 'seq': 14},
                {'rtt': 0.11103701591491699, 'seq': 15},
                {'rtt': 0.14150500297546387, 'seq': 16},
                {'rtt': 0.028972864151000977, 'seq': 17},
                {'rtt': 0.08305692672729492, 'seq': 18}],
            'host': '184.27.21.169',
            'stats': {'avg': 0.05489287111494276, 'loss': 0.0, 'recv': 18, 'sent': 18}
        },
        {
            'history': [{'rtt': 0.3427560329437256, 'seq': 1},
                {'rtt': 0.2158219814300537, 'seq': 2},
                {'rtt': 0.22676992416381836, 'seq': 3},
                {'rtt': 0.2495269775390625, 'seq': 4},
                {'rtt': 0.22198200225830078, 'seq': 5},
                {'rtt': 0.20645713806152344, 'seq': 6},
                {'rtt': 0.273914098739624, 'seq': 7},
                {'rtt': 0.2166590690612793, 'seq': 8},
                {'rtt': 0.25643014907836914, 'seq': 9},
                {'rtt': 0.2692849636077881, 'seq': 10},
                {'rtt': 0.24141311645507812, 'seq': 11},
                {'rtt': 0.21486496925354004, 'seq': 12},
                {'rtt': 0.22596001625061035, 'seq': 13},
                {'rtt': 0.3320810794830322, 'seq': 14},
                {'rtt': 0.25244903564453125, 'seq': 15},
                {'rtt': 0.30961012840270996, 'seq': 16},
                {'rtt': 0.2183818817138672, 'seq': 17},
                {'rtt': 0.2613370418548584, 'seq': 18}],
            'host': '199.204.44.194',
            'stats': {'avg': 0.25198331144120956, 'loss': 0.0, 'recv': 18, 'sent': 18}
        }
    ];

    const const_keyorder = ['sent', 'recv', 'avg', 'loss'];


    d3.select("body").selectAll("div.box")
            .data(jdata)
            .enter()
            .append("div")
            .attr("id", get_hostname)
            .attr("class", "box")
            .style("width", (box_wid + 20) + "px").style("height", (box_hei + 20) + "px");


    for (var res in jdata) {

        var selec_table = d3.select("body div.box[id='" + jdata[res]["host"] + "']")
                .selectAll("table");

        // console.log(Array(jdata[res]["stats"]));
        selec_table
                .data(Array(jdata[res]["stats"]))
                .enter()
                .append("table")
                .attr("class", "pure-table")
                .append("caption").style("text-align", "left")
                .text(jdata[res]["host"]);

        selec_table = d3.select("body div.box[id='" + jdata[res]["host"] + "']")
                .selectAll("table");

        selec_table//.select("table")
                .selectAll("thead")
                .data(Array(jdata[res]["stats"]))
                .enter()
                .append("thead");

        selec_table
                .selectAll("tbody")
                .data(Array(jdata[res]["stats"]))
                .enter()
                .append("tbody");

        selec_table
                .select("thead")
                .selectAll("th")
                .data(const_keyorder)
                .enter()
                .append("th")
                .text(function (d) {
                    return d.charAt(0).toUpperCase() + d.slice(1);
                });

        selec_table
                .select("tbody")
                .selectAll("tr")
                .data(Array(jdata[res]["stats"]))
                .enter()
                .append("tr");

        selec_table
                .select("tbody").selectAll("tr").selectAll("td")
                .data(ordered_values(jdata[res]["stats"], const_keyorder))
                .enter()
                .append("td");

        selec_table
                .select("tbody").selectAll("tr")
                .selectAll("td")
                .data(d3.values(jdata[res]["stats"]))
                .exit()
                .remove();

        selec_table
                .select("tbody").selectAll("tr")
                .selectAll("td")
                .data(ordered_values(jdata[res]["stats"], const_keyorder))
//                        .data(d3.values(jdata[res]["stats"]))
                .text(function (d) {
                    return d;
                });

        selec_table
                .data(Array(jdata[res]["stats"]))
                .exit()
                .remove();

        var selec_box = d3.select("body div.box[id='" + jdata[res]["host"] + "']")
                .selectAll("div.history");

        selec_box
                .data(Array(jdata[res]["history"]))
                .enter()
                .append("div")
                .attr("class", "history box")
                .style("width", box_wid + "px").style("height", box_hei + "px");

        selec_box
                .data(Array(jdata[res]["history"]))
                .exit()
                .remove();

        selec_box = d3.select("body div.box[id='" + jdata[res]["host"] + "'] div.history")
                .selectAll("div.v-bar");

        selec_box
                .data(jdata[res]["history"])
                .enter()
                .append("div")
                .attr("class", "v-bar")
                .style("visibility", "hidden")
                .append("span");

        selec_box
                .data(jdata[res]["history"])
                .exit()
                .remove();

        selec_box = d3.select("body div.box[id='" + jdata[res]["host"] + "'] div.history")
                .selectAll("div.v-bar");

        selec_box
                .data(jdata[res]["history"])
                .attr("class", "v-bar")
                .style("height", get_hei)
                .style("left", function (d, i) {
                    return (2 + i * 27) + "px"
                })
                .style("background-color", get_color)
                .style("visibility", "visible")
                .select("span")
                .text(get_seq);
    };

</script>

</body>
</html>